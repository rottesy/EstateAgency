# Описание основных функций системы

Данный документ содержит описание 10 ключевых функций информационной системы управления агентством недвижимости.

---

## 1. EstateAgency::getInstance()

**Назначение:** Получение единственного экземпляра класса `EstateAgency` (реализация паттерна Singleton).

**Описание:** Функция обеспечивает создание и возврат единственного экземпляра класса `EstateAgency`, который является центральным оркестратором всей системы. При первом вызове создается новый экземпляр, при последующих вызовах возвращается уже существующий экземпляр. Это гарантирует, что в системе существует только один объект, управляющий всеми менеджерами (PropertyManager, ClientManager, TransactionManager, AuctionManager) и координирующий их работу.

**Параметры:** Отсутствуют.

**Возвращаемое значение:** Указатель на единственный экземпляр `EstateAgency*`.

**Особенности:** Функция является статической, что позволяет вызывать ее без создания объекта класса. При создании экземпляра автоматически создается директория для хранения данных, если она не существует.

**Пример использования:**
```cpp
EstateAgency *agency = EstateAgency::getInstance();
agency->loadAllData();
```

---

## 2. EstateAgency::saveAllData()

**Назначение:** Централизованное сохранение всех данных системы в файлы.

**Описание:** Функция выполняет сохранение всех данных агентства в текстовые файлы через `FileManager`. Сохраняются данные о недвижимости (properties.txt), клиентах (clients.txt), сделках (transactions.txt) и аукционах (auctions.txt) в директорию, указанную в `dataDirectory` (по умолчанию "data"). Функция обрабатывает исключения `FileManagerException` и `std::filesystem::filesystem_error`, игнорируя их для обеспечения стабильности работы системы даже при ошибках записи на диск.

**Параметры:** Отсутствуют (функция константная).

**Возвращаемое значение:** `void`.

**Особенности:** Функция вызывается автоматически при закрытии приложения через `destroyInstance()`. Все исключения обрабатываются молча, чтобы не прерывать работу приложения при проблемах с файловой системой.

**Пример использования:**
```cpp
agency->saveAllData(); // Сохранение всех данных перед закрытием
```

---

## 3. EstateAgency::loadAllData()

**Назначение:** Централизованная загрузка всех данных системы из файлов при запуске приложения.

**Описание:** Функция выполняет загрузку всех данных агентства из текстовых файлов через `FileManager`. Загружаются данные о недвижимости, клиентах, сделках и аукционах из директории `dataDirectory`. Функция обрабатывает исключения `FileManagerException` и `std::filesystem::filesystem_error`, игнорируя их для обеспечения работы приложения даже при отсутствии файлов (первый запуск) или ошибках чтения.

**Параметры:** Отсутствуют.

**Возвращаемое значение:** `void`.

**Особенности:** Функция вызывается автоматически при инициализации `MainWindow`. Если файлы не существуют или содержат некорректные данные, система продолжает работу с пустыми коллекциями, что обеспечивает стабильность приложения.

**Пример использования:**
```cpp
agency->loadAllData(); // Загрузка данных при запуске
```

---

## 4. PropertyManager::addProperty()

**Назначение:** Добавление объекта недвижимости в коллекцию менеджера.

**Описание:** Функция добавляет новый объект недвижимости в коллекцию менеджера с проверкой уникальности идентификатора. Перед добавлением выполняется проверка, что переданный указатель не является `nullptr`, и что объект с таким идентификатором еще не существует в коллекции. При нарушении этих условий выбрасывается исключение `PropertyManagerException` с описанием причины ошибки. Объект передается через `std::unique_ptr`, что обеспечивает автоматическое управление памятью.

**Параметры:** 
- `property` - `std::unique_ptr<Property>` - умный указатель на объект недвижимости для добавления.

**Возвращаемое значение:** `void`.

**Исключения:** 
- `PropertyManagerException` - если объект равен `nullptr` или объект с таким ID уже существует.

**Особенности:** Функция использует move-семантику для передачи владения объектом в коллекцию менеджера. После успешного добавления объект становится частью коллекции и управляется менеджером.

**Пример использования:**
```cpp
auto property = std::make_unique<Apartment>(params);
propertyManager.addProperty(std::move(property));
```

---

## 5. PropertyManager::findProperty()

**Назначение:** Поиск объекта недвижимости по идентификатору.

**Описание:** Функция выполняет поиск объекта недвижимости в коллекции менеджера по заданному идентификатору. Поиск выполняется с использованием алгоритма `std::ranges::find_if` из стандартной библиотеки C++20, что обеспечивает эффективность поиска. Если объект найден, возвращается указатель на него, если не найден - возвращается `nullptr`.

**Параметры:** 
- `id` - `const std::string&` - идентификатор объекта недвижимости для поиска.

**Возвращаемое значение:** `Property*` - указатель на найденный объект или `nullptr`, если объект не найден.

**Особенности:** Функция возвращает указатель на объект, который остается в коллекции менеджера. Не следует удалять объект через этот указатель - для удаления используется метод `removeProperty()`.

**Пример использования:**
```cpp
Property *prop = propertyManager.findProperty("12345678");
if (prop) {
    // Работа с найденным объектом
}
```

---

## 6. PropertyManager::searchByAddress()

**Назначение:** Поиск объектов недвижимости по адресу с частичным совпадением.

**Описание:** Функция выполняет поиск объектов недвижимости в коллекции менеджера по компонентам адреса (город, улица, дом) с использованием частичного совпадения. Поиск выполняется без учета регистра символов. Если какой-либо из параметров адреса пустой, он игнорируется при поиске. Функция возвращает вектор указателей на все объекты, которые соответствуют критериям поиска.

**Параметры:** 
- `city` - `const std::string&` - город для поиска (может быть пустым).
- `street` - `const std::string&` - улица для поиска (может быть пустым, по умолчанию "").
- `house` - `const std::string&` - дом для поиска (может быть пустым, по умолчанию "").

**Возвращаемое значение:** `std::vector<Property*>` - вектор указателей на найденные объекты недвижимости.

**Особенности:** Функция использует алгоритм `std::ranges::filter` для фильтрации объектов по критериям поиска. Поиск выполняется по частичному совпадению, что позволяет находить объекты даже при неполном указании адреса.

**Пример использования:**
```cpp
auto properties = propertyManager.searchByAddress("Минск", "Семашко", "");
// Найдет все объекты в Минске на улице Семашко
```

---

## 7. TransactionManager::addTransaction()

**Назначение:** Добавление сделки в коллекцию менеджера с проверкой валидности.

**Описание:** Функция добавляет новую сделку в коллекцию менеджера с проверкой, что переданный указатель не является `nullptr` и что сделка с таким идентификатором еще не существует в коллекции. При нарушении этих условий выбрасывается исключение `TransactionManagerException` с описанием причины ошибки. Сделка передается через `std::shared_ptr`, что позволяет нескольким компонентам системы совместно использовать одну и ту же сделку.

**Параметры:** 
- `transaction` - `std::shared_ptr<Transaction>` - умный указатель на объект сделки для добавления.

**Возвращаемое значение:** `void`.

**Исключения:** 
- `TransactionManagerException` - если сделка равна `nullptr` или сделка с таким ID уже существует.

**Особенности:** Функция использует shared ownership для управления памятью, что позволяет безопасно передавать сделки между различными компонентами системы без риска преждевременного удаления.

**Пример использования:**
```cpp
auto transaction = std::make_shared<Transaction>(id, propertyId, clientId, price, status);
transactionManager.addTransaction(transaction);
```

---

## 8. TransactionManager::getTransactionsByProperty()

**Назначение:** Получение всех сделок, связанных с конкретным объектом недвижимости.

**Описание:** Функция выполняет поиск всех сделок в коллекции менеджера, которые связаны с указанным объектом недвижимости по идентификатору. Поиск выполняется путем сравнения идентификатора объекта недвижимости в каждой сделке с заданным идентификатором. Функция возвращает вектор указателей на все найденные сделки, что позволяет анализировать историю операций с конкретным объектом недвижимости.

**Параметры:** 
- `propertyId` - `std::string_view` - идентификатор объекта недвижимости для поиска сделок.

**Возвращаемое значение:** `std::vector<Transaction*>` - вектор указателей на все сделки, связанные с указанным объектом недвижимости.

**Особенности:** Функция использует `std::string_view` для эффективной передачи строкового параметра без копирования. Если сделок не найдено, возвращается пустой вектор.

**Пример использования:**
```cpp
auto transactions = transactionManager.getTransactionsByProperty("12345678");
// Получить все сделки для объекта недвижимости с ID "12345678"
```

---

## 9. FileManager::saveProperties()

**Назначение:** Сохранение коллекции объектов недвижимости в текстовый файл.

**Описание:** Функция выполняет сохранение всех объектов недвижимости из менеджера в текстовый файл с использованием разделителя полей '|'. Каждый объект сериализуется в строку через метод `toFileString()` сущности, который формирует строку в формате с разделителями. Функция открывает файл для записи, записывает все объекты построчно и закрывает файл. При ошибке открытия файла выбрасывается исключение `FileManagerException`.

**Параметры:** 
- `manager` - `const PropertyManager&` - менеджер недвижимости, из которого извлекаются объекты для сохранения.
- `filename` - `const std::string&` - путь к файлу для сохранения данных.

**Возвращаемое значение:** `void`.

**Исключения:** 
- `FileManagerException` - если не удалось открыть файл для записи.

**Особенности:** Функция является статической и не требует создания экземпляра `FileManager`. Данные записываются в текстовом формате, что обеспечивает читаемость и возможность ручного редактирования при необходимости.

**Пример использования:**
```cpp
FileManager::saveProperties(propertyManager, "data/properties.txt");
```

---

## 10. FileManager::loadProperties()

**Назначение:** Загрузка коллекции объектов недвижимости из текстового файла.

**Описание:** Функция выполняет загрузку объектов недвижимости из текстового файла с разделителями полей '|'. Функция читает файл построчно, парсит каждую строку, определяет тип недвижимости по маркеру (APARTMENT, HOUSE, COMMERCIAL) и создает соответствующий объект. При парсинге строки извлекаются все поля данных (идентификатор, адрес, цена, площадь и специфические поля для каждого типа). Если файл не существует, функция завершается без ошибки, позволяя системе работать с пустой коллекцией. При ошибках парсинга отдельных строк эти строки пропускаются, что обеспечивает устойчивость к частично поврежденным данным.

**Параметры:** 
- `manager` - `PropertyManager&` - менеджер недвижимости, в который загружаются объекты.
- `filename` - `const std::string&` - путь к файлу для загрузки данных.

**Возвращаемое значение:** `void`.

**Исключения:** Обрабатываются внутри функции, некорректные строки пропускаются.

**Особенности:** Функция является статической и использует методы `setProperties()` менеджера для установки загруженных данных. Функция устойчива к ошибкам - если файл не существует или содержит некорректные данные, система продолжает работу.

**Пример использования:**
```cpp
FileManager::loadProperties(propertyManager, "data/properties.txt");
```

---

## Заключение

Описаны 10 ключевых функций системы, охватывающих основные операции управления данными: создание и получение экземпляра системы, сохранение и загрузку данных, добавление и поиск объектов недвижимости и сделок, а также работу с файлами. Все функции реализованы с учетом принципов послойной архитектуры и обеспечивают надежную работу системы с обработкой исключительных ситуаций.


